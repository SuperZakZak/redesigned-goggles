# Apple Wallet Integration - –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ü—Ä–æ–µ–∫—Ç: Loy - Digital Loyalty Platform
–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∫–∞—Ä—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Apple Wallet –∏ Google Wallet.

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:**
- Backend: Node.js + Express + TypeScript
- Database: MongoDB + Mongoose
- Cache: Redis
- Apple Wallet: passkit-generator
- Google Wallet: Google Wallet API
- Logging: Winston

## ‚úÖ –î–û–°–¢–ò–ì–ù–£–¢–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–µ—Ä–≤–µ—Ä
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3000
- ‚úÖ MongoDB –∏ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —á–µ—Ä–µ–∑ Docker
- ‚úÖ APNs –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (production: true)
- ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (–≤–∫–ª—é—á–∞—è passkit-generator)
- ‚úÖ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

### 2. API Endpoints (—Ä–∞–±–æ—á–∏–µ)
- ‚úÖ **Health Check**: `GET /health` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞**: `POST /api/v1/customers`
  ```json
  {
    "name": "Test User",
    "phone": "+79991234567", 
    "email": "test@example.com"
  }
  ```
  –û—Ç–≤–µ—Ç: `{ success: true, data: { customer: { id, name, phone, cardNumber, balance, ... } } }`

- ‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Apple Wallet –∫–∞—Ä—Ç—ã**: `POST /api/v1/passes/apple`
  ```json
  { "customerId": "689258a11e385d089d1ee487" }
  ```
  –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: .pkpass —Ñ–∞–π–ª (–±–∏–Ω–∞—Ä–Ω—ã–π)
  –¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç: `{ success: false, error: "Failed to generate Apple Wallet pass" }`

- ‚úÖ **–†–µ–∑–µ—Ä–≤–Ω—ã–π endpoint**: `POST /apple` (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `passkit-generator` - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ APNs –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ `production: true`
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –≤—ã–∑—ã–≤–∞–ª–∏ –æ—à–∏–±–∫–∏ Mongoose - –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ
- ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API passkit-generator - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
  - –£–±—Ä–∞–Ω—ã `pass.headerFields.add()` –∏ –ø–æ–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  - –£–±—Ä–∞–Ω–æ –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ read-only –ø–æ–ª–µ–π
  - –£–±—Ä–∞–Ω—ã –ø–æ–ª—è –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ PKPass.from()
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ serialNumber ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π

### 4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
**–î–≤–∞ —Å–µ—Ä–≤–∏—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Apple Wallet:**
1. `/src/services/pass.service.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@walletpass/pass-js`
2. `/src/services/passService.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `passkit-generator` ‚≠ê (–æ—Å–Ω–æ–≤–Ω–æ–π)

**–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Ä–æ—É—Ç—ã:**
- `/src/controllers/pass.controller.ts`
- `/src/routes/passRoutes.ts`
- `/src/app.ts` - fallback route `/apple`

## ‚ö†Ô∏è –¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Apple Wallet

### –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
```
10:22:58 [error]: Failed to generate Apple pass {
  "error": "Invalid PEM formatted message."
}
```

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã
1. **–ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –≤—Å–µ API –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞–±–∏–ª–µ–Ω
2. **–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–¥–ø–∏—Å–∏ .pkpass —Ñ–∞–π–ª–∞**
3. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö/–∫–ª—é—á–∞—Ö** –¥–ª—è Apple Wallet

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
**–§–∞–π–ª**: `/src/config/wallet.ts`
```typescript
export const walletConfig = {
  appleWwdrPath: './certificates/wwdr-g4.pem',
  appleCertPath: './certificates/Certificates.p12', 
  appleCertPassword: 'paPlr8seGgpB'
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ certificates:**
```
certificates/
‚îú‚îÄ‚îÄ wwdr-g4.pem          # WWDR —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Apple
‚îú‚îÄ‚îÄ Certificates.p12     # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (—Å–æ–¥–µ—Ä–∂–∏—Ç cert + key)
‚îú‚îÄ‚îÄ cert-clean.pem       # –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (PEM)
‚îú‚îÄ‚îÄ key-pkcs8.pem        # –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–ª—é—á (PEM)
‚îî‚îÄ‚îÄ ...
```

### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ—à–µ–Ω–∏—è
–°–æ–≥–ª–∞—Å–Ω–æ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞, —Ä–∞–Ω–µ–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç APPLE_WALLET_* –Ω–∞–¥ APPLE_*)
- ‚úÖ –ü—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º (certificates/ –≤–º–µ—Å—Ç–æ certs/)
- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è WWDR –∏–∑ DER –≤ PEM —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ cert.pem –∏ key.pem –∏–∑ P12 —Ñ–∞–π–ª–∞
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ PEM —Ñ–∞–π–ª–æ–≤ –æ—Ç Bag Attributes

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Ç–µ–∫—É—â–µ–π –æ—à–∏–±–∫–∏
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç P12 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞** –∏–ª–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å passkit-generator
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ PEM —Ñ–∞–π–ª–æ–≤**
3. **–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç**
4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è P12 —Ñ–∞–π–ª–∞**
5. **–ü—Ä–æ–±–ª–µ–º—ã —Å WWDR —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º**

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò –î–õ–Ø –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ –° –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê–ú–ò

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å P12 —Ñ–∞–π–ª–∞ –∏ –ø–∞—Ä–æ–ª—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç WWDR —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ PEM —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ P12
- –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ Apple Developer Portal
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @walletpass/pass-js)

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ .pkpass —Ñ–∞–π–ª–∞
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

## üìã –¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```bash
cd /Users/zakhar/Desktop/loy
npm run build
node dist/index.js
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
```bash
curl -X POST http://localhost:3000/api/v1/customers \
  -H "Content-Type: application/json" \
  -d '{"name": "Test User", "phone": "+79991234567", "email": "test@example.com"}'
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Apple Wallet –∫–∞—Ä—Ç—ã
```bash
curl -X POST http://localhost:3000/api/v1/passes/apple \
  -H "Content-Type: application/json" \
  -d '{"customerId": "CUSTOMER_ID_FROM_PREVIOUS_STEP"}' \
  --output test-wallet-pass.pkpass
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```bash
file test-wallet-pass.pkpass  # –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å: Zip archive data
# –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: JSON data - –∑–Ω–∞—á–∏—Ç –æ—à–∏–±–∫–∞
```

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –û–ö–†–£–ñ–ï–ù–ò–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```
NODE_ENV=development
PORT=3000
API_PREFIX=/api/v1

# Database
MONGODB_URI=mongodb://localhost:27017/loy_dev
REDIS_HOST=localhost
REDIS_PORT=6379

# Apple Wallet
APPLE_WALLET_WWDR_PATH=./certificates/wwdr-g4.pem
APPLE_WALLET_CERT_PATH=./certificates/Certificates.p12
APPLE_WALLET_CERT_PASSWORD=paPlr8seGgpB
```

### Docker —Å–µ—Ä–≤–∏—Å—ã
```bash
# MongoDB –∏ Redis –∑–∞–ø—É—â–µ–Ω—ã –≤ Docker
docker ps  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

---

**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ Apple Wallet
**–î–∞—Ç–∞**: 2025-08-06
**–í–µ—Ä—Å–∏—è**: –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö API –ø—Ä–æ–±–ª–µ–º
