# –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ Apple Wallet –≤ –ø—Ä–æ–µ–∫—Ç–µ Loy

## üéØ –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê

**–ü—Ä–æ–µ–∫—Ç**: Loy - Digital Loyalty Platform (—Ü–∏—Ñ—Ä–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Node.js + Express + TypeScript + MongoDB + Redis + passkit-generator
**–õ–æ–∫–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞**: `/Users/zakhar/Desktop/loy`

## ‚úÖ –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° (–í–°–ï –†–ê–ë–û–¢–ê–ï–¢)

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è: `node dist/index.js` (–ø–æ—Ä—Ç 3000)
- ‚úÖ MongoDB –∏ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —á–µ—Ä–µ–∑ Docker
- ‚úÖ APNs –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫: `npm run build`
- ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (–≤–∫–ª—é—á–∞—è passkit-generator)

### API Endpoints (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ)
- ‚úÖ `GET /health` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ `POST /api/v1/customers` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  ```json
  {"name": "Test User", "phone": "+79991234567", "email": "test@example.com"}
  ```
- ‚úÖ `POST /api/v1/passes/apple` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Apple Wallet –∫–∞—Ä—Ç—ã
  ```json
  {"customerId": "CUSTOMER_ID"}
  ```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å passkit-generator - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ APNs –ø—Ä–æ–≤–∞–π–¥–µ—Ä - –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ production: true
- ‚úÖ API passkit-generator - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –º–µ—Ç–æ–¥—ã:
  - –£–±—Ä–∞–Ω—ã `pass.headerFields.add()` (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
  - –£–±—Ä–∞–Ω–æ –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ read-only –ø–æ–ª–µ–π
  - –£–±—Ä–∞–Ω—ã –ø–æ–ª—è –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ PKPass.from()
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —Å–æ–∑–¥–∞–Ω–∏–µ ‚Üí serialNumber ‚Üí –ø–æ–ª—è

## ‚ö†Ô∏è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Apple Wallet

### –û—à–∏–±–∫–∞
```
[error]: Failed to generate Apple pass {
  "error": "Invalid PEM formatted message."
}
```

### –†–∞–±–æ—á–∏–π –∫–æ–¥ (–ù–ï –¢–†–û–ì–ê–¢–¨!)
**–§–∞–π–ª**: `/src/services/passService.ts` (—Å—Ç—Ä–æ–∫–∏ 28-65)
```typescript
const pass = await PKPass.from({
  model: path.resolve('templates', 'apple', 'loy.pass'),
  certificates: {
    wwdr: walletConfig.appleWwdrPath,
    signerCert: walletConfig.appleCertPath,
    signerKey: walletConfig.appleCertPath, // P12 file contains both cert and key
    signerKeyPassphrase: walletConfig.appleCertPassword,
  },
});

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º serialNumber –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
pass.serialNumber = serialNumber;
pass.setBarcodes({
  message: customer.cardNumber || customer.id,
  format: 'PKBarcodeFormatQR',
  messageEncoding: 'iso-8859-1'
});

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã
pass.headerFields.push({
  key: 'loy',
  label: 'LOYALTY',
  value: 'Loy Club'
});
// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
**–§–∞–π–ª**: `/src/config/wallet.ts`
```typescript
export const walletConfig = {
  appleWwdrPath: './certificates/wwdr-g4.pem',
  appleCertPath: './certificates/Certificates.p12',
  appleCertPassword: 'paPlr8seGgpB'
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ certificates
```
certificates/
‚îú‚îÄ‚îÄ wwdr-g4.pem          # WWDR —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Apple
‚îú‚îÄ‚îÄ Certificates.p12     # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (—Å–æ–¥–µ—Ä–∂–∏—Ç cert + key)
‚îú‚îÄ‚îÄ cert-clean.pem       # –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (PEM)
‚îú‚îÄ‚îÄ key-pkcs8.pem        # –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–ª—é—á (PEM)
‚îî‚îÄ‚îÄ ...
```

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–£–ñ–ï –°–î–ï–õ–ê–ù–û)
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ü—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ WWDR –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ DER –≤ PEM
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω—ã cert.pem –∏ key.pem –∏–∑ P12
- ‚úÖ –û—á–∏—â–µ–Ω—ã PEM —Ñ–∞–π–ª—ã –æ—Ç Bag Attributes

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ "Invalid PEM formatted message"
1. **P12 —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å**
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ PEM —Ñ–∞–π–ª–æ–≤**
3. **–£—Å—Ç–∞—Ä–µ–≤—à–∏–π/–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç**
4. **–ü—Ä–æ–±–ª–µ–º—ã —Å WWDR —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º**
5. **–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π passkit-generator**

## üéØ –ó–ê–î–ê–ß–ê

**–ù–£–ñ–ù–û**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É "Invalid PEM formatted message" –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Apple Wallet –∫–∞—Ä—Ç—ã

**–ü–û–î–•–û–î–´**:
1. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å, —Ñ–æ—Ä–º–∞—Ç, –ø–∞—Ä–æ–ª–∏
2. **–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ PEM —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ P12
3. **–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** - –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–µ —á–µ—Ä–µ–∑ Apple Developer Portal
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—à–∞–≥–æ–≤–æ** - —Å–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## üß™ –¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´

### –ó–∞–ø—É—Å–∫ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
cd /Users/zakhar/Desktop/loy

# 1. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
npm run build
node dist/index.js

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
curl -X POST http://localhost:3000/api/v1/customers \
  -H "Content-Type: application/json" \
  -d '{"name": "Test User", "phone": "+79991234567", "email": "test@example.com"}'

# 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (–ó–î–ï–°–¨ –û–®–ò–ë–ö–ê)
curl -X POST http://localhost:3000/api/v1/passes/apple \
  -H "Content-Type: application/json" \
  -d '{"customerId": "CUSTOMER_ID_FROM_STEP_2"}' \
  --output test.pkpass

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
file test.pkpass
# –û–∂–∏–¥–∞–µ—Ç—Å—è: Zip archive data
# –ü–æ–ª—É—á–∞–µ—Ç—Å—è: JSON data (–æ—à–∏–±–∫–∞)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ P12 —Ñ–∞–π–ª–∞
openssl pkcs12 -info -in certificates/Certificates.p12 -passin pass:paPlr8seGgpB

# –ü—Ä–æ–≤–µ—Ä–∫–∞ WWDR
openssl x509 -in certificates/wwdr-g4.pem -text -noout

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö PEM
openssl x509 -in certificates/cert-clean.pem -text -noout
openssl rsa -in certificates/key-pkcs8.pem -check
```

## üìã –í–ê–ñ–ù–´–ï –§–ê–ô–õ–´

**–ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨** (–∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ):
- `/src/services/passService.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- `/src/config/wallet.ts` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É—Ç–µ–π
- `/src/app.ts` - —Ä–æ—É—Ç—ã –∏ middleware

**–ú–û–ñ–ù–û –ò–ó–ú–ï–ù–Ø–¢–¨** (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ —Ç–µ—Å—Ç—ã):
- `/certificates/` - –ø–∞–ø–∫–∞ —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- –û–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏:
1. `curl` –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π .pkpass —Ñ–∞–π–ª
2. `file test.pkpass` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å "Zip archive data"
3. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤ Apple Wallet –Ω–∞ iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

---

**–ù–∞—á–Ω–∏ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–µ–∫—É—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã "Invalid PEM formatted message".**
