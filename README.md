# Loy - Digital Loyalty Platform

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Apple Wallet –∏ Google Wallet.

## üöÄ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apple Wallet –∏ Google Wallet
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ push-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- üë• –ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑–æ–π
- üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM/POS —Å–∏—Å—Ç–µ–º–∞–º–∏
- üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend**: Node.js + Express + TypeScript
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: MongoDB + Mongoose
- **–ö—ç—à**: Redis
- **Wallet**: node-passbook (Apple), Google Wallet API
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Winston
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è**: Docker + Docker Compose
- **–ü—Ä–æ–∫—Å–∏**: Nginx

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js >= 18.0.0
- npm >= 8.0.0
- Docker –∏ Docker Compose (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- MongoDB (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker)
- Redis (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
git clone <repository-url>
cd loy
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

### 3. –ó–∞–ø—É—Å–∫ —Å Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run docker:dev

# –ü—Ä–æ–¥–∞–∫—à–Ω
npm run docker:prod
```

### 4. –ó–∞–ø—É—Å–∫ –±–µ–∑ Docker

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ MongoDB –∏ Redis –∑–∞–ø—É—â–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ
npm run dev
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ controllers/     # HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ services/        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ models/         # MongoDB —Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ types/          # TypeScript —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ utils/          # –£—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ config/         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ app.ts          # Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ index.ts        # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```

## üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev              # –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run build           # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
npm run start           # –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω –≤–µ—Ä—Å–∏–∏

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
npm run test            # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
npm run test:watch      # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ watch —Ä–µ–∂–∏–º–µ

# –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
npm run lint            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
npm run lint:fix        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–∏–Ω–≥–∞
npm run format          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

# Docker
npm run docker:dev      # –ó–∞–ø—É—Å–∫ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Docker
npm run docker:prod     # –ó–∞–ø—É—Å–∫ prod –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Docker
```

## üåê API Endpoints

### Health Check
- `GET /health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞

### Customers (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- `POST /api/v1/customers` - –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
- `GET /api/v1/customers` - –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
- `GET /api/v1/customers/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
- `PUT /api/v1/customers/:id` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞

### Transactions (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- `POST /api/v1/transactions` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `GET /api/v1/transactions` - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### Wallets (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- `POST /api/v1/wallets/apple` - –°–æ–∑–¥–∞–Ω–∏–µ Apple Wallet –∫–∞—Ä—Ç—ã
- `POST /api/v1/wallets/google` - –°–æ–∑–¥–∞–Ω–∏–µ Google Wallet –∫–∞—Ä—Ç—ã

## üñºÔ∏è Apple Wallet ‚Äî –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞—Å—Å–µ—Ç–∞–º

–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `templates/apple/loy.pass/`.
–≠—Ç–∏ –∞—Å—Å–µ—Ç—ã –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ –±—É–¥—É—â–∏–π –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

| –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω | –†–∞–∑–º–µ—Ä (px) | Scale | –§–æ—Ä–º–∞—Ç | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
| -------------- | ---------- | ----------- | ----- | ------- | ---------- |
| `icon.png`     | ‚úÖ         | 29 √ó 29     | @1x   | PNG     | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–∞—Ä—Ç |
| `icon@2x.png`  | ‚úÖ         | 58 √ó 58     | @2x   | PNG     | Retina-–≤–µ—Ä—Å–∏—è `icon.png` |
| `logo.png`     | ‚úÖ         | ‚â§160 √ó 50   | @1x   | PNG     | –õ–æ–≥–æ—Ç–∏–ø –Ω–∞ —Ñ—Ä–æ–Ω—Ç-—Å–∞–π–¥ –∫–∞—Ä—Ç—ã, —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π |
| `logo@2x.png`  | ‚úÖ         | ‚â§320 √ó 100  | @2x   | PNG     | Retina-–≤–µ—Ä—Å–∏—è `logo.png` |
| `strip.png`    | ‚¨ú         | 375 √ó 123   | @1x   | PNG     | –í–µ—Ä—Ö–Ω–∏–π –±–∞–Ω–Ω–µ—Ä (–ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) |
| `strip@2x.png` | ‚¨ú         | 750 √ó 246   | @2x   | PNG     | Retina-–≤–µ—Ä—Å–∏—è `strip.png` |
| `background.png` | ‚¨ú       | 1800 √ó 2200 | @1x   | PNG     | –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –¶–≤–µ—Ç–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å sRGB, 72 dpi.
2. –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω (–∫—Ä–æ–º–µ `background.png`).
3. –ë–µ–∑ –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–∞ –¥–ª—è `strip*` –∏ `background.png` (Apple —Å–æ–≤–µ—Ç—É–µ—Ç).
4. –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ < 1 MB.
5. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∞—Ö `@1x/@2x`.

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –∞—Å—Å–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `.pkpass` –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /api/v1/passes/apple/:serialNumber/push`, —á—Ç–æ–±—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—É—á–∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Helmet.js –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- Rate limiting
- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- Winston –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- Health check endpoint
- Graceful shutdown
- Error handling –∏ reporting

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
npm run test

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
npm run test -- --coverage

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
npm run test -- --testNamePattern="Customer"
```

## üê≥ Docker

### Development
```bash
docker-compose -f docker-compose.dev.yml up
```

### Production
```bash
docker-compose up
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `logs/`:
- `app.log` - –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏
- `error.log` - —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
- `exceptions.log` - –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- `rejections.log` - –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ Promise rejections

## ü§ù –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º KISS
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TypeScript —Å—Ç—Ä–æ–≥–æ (–±–µ–∑ `any`)
3. –§—É–Ω–∫—Ü–∏–∏ –Ω–µ –±–æ–ª–µ–µ 50 —Å—Ç—Ä–æ–∫
4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. Try-catch –¥–ª—è –≤—Å–µ—Ö async –æ–ø–µ—Ä–∞—Ü–∏–π
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License

## üë• –ö–æ–º–∞–Ω–¥–∞

Loy Development Team

---

## üçè –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apple Wallet: –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∏ –†–µ—à–µ–Ω–∏–µ

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ, —Ä–∞–±–æ—á–µ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `.pkpass` —Ñ–∞–π–ª–æ–≤ –¥–ª—è Apple Wallet, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–µ –ø–æ—Å–ª–µ —Å–µ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

### 1. –í—ã–±–æ—Ä –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `passkit-generator`, –Ω–æ –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ `Invalid PEM formatted message`. –í –∏—Ç–æ–≥–µ –º—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ **`@walletpass/pass-js` v6.9.1** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é, –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ—à–∏–ª–∞ –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã.

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–ö–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø)

–ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å `.p12` —Ñ–∞–π–ª–∞–º–∏ –∏–ª–∏ –±–∞–∑–æ–≤—ã–º–∏ `.pem` —Ñ–∞–π–ª–∞–º–∏ –æ–∫–∞–∑–∞–ª–∞—Å—å –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ–π. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ ‚Äî —ç—Ç–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤. –í—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/certificates`.

**–®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç `.p12` —Ñ–∞–π–ª–∞**

- –ò–∑ –°–≤—è–∑–∫–∏ –ö–ª—é—á–µ–π (Keychain Access) –Ω–∞ macOS —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤–∞—à `Pass Type ID Certificate` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `.p12`. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ `.env` –∫–∞–∫ `APPLE_WALLET_CERTIFICATE_PASSWORD`.

**–®–∞–≥ 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (`cert.pem`)**

```bash
openssl pkcs12 -in Certificates.p12 -clcerts -nokeys -out certificates/cert.pem
```

**–®–∞–≥ 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (`key.pem`)**

```bash
openssl pkcs12 -in Certificates.p12 -nocerts -out certificates/key.pem
```

**–®–∞–≥ 4: –û—á–∏—Å—Ç–∫–∞ –∫–ª—é—á–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç "Bag Attributes"**

OpenSSL –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ PEM-—Ñ–∞–π–ª—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (`Bag Attributes`), –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–µ `@walletpass/pass-js`. –ò—Ö –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞, —á—Ç–æ–±—ã –æ—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ —Å–µ–∫—Ü–∏–∏ `-----BEGIN CERTIFICATE-----` –∏ `-----BEGIN PRIVATE KEY-----`.

- –°–æ–∑–¥–∞–π—Ç–µ `cert-clean.pem` –∏ `key-clean.pem` —Å –æ—á–∏—â–µ–Ω–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

**–®–∞–≥ 5: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–ª—é—á–∞ –≤ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç PKCS#8 (–†–µ—à–∞—é—â–∏–π —à–∞–≥)**

–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `node-forge` –≤ `@walletpass/pass-js` –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–ª—é—á–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PKCS#8. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.

```bash
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in certificates/key-clean.pem -out certificates/key-pkcs8.pem
```

> **–í–∞–∂–Ω–æ**: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç `Apple Worldwide Developer Relations Certification Authority` (WWDR) –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω. –û–Ω —É–∂–µ –≤–∫–ª—é—á–µ–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `@walletpass/pass-js`.

### 3. –§–∏–Ω–∞–ª—å–Ω—ã–π –ö–æ–¥ –¥–ª—è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–∞—Ä—Ç—ã

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã `setCertificate()` –∏ `setPrivateKey()`. –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫.

```javascript
// –ü—Ä–∏–º–µ—Ä –∏–∑ test-final-pass.js

const { Template } = require('@walletpass/pass-js');
const fs = require('fs').promises;
const path = require('path');

// 1. –ü—É—Ç–∏ –∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
const certPath = './certificates/cert-clean.pem';
const keyPath = './certificates/key-pkcs8.pem'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º PKCS#8 –∫–ª—é—á!

// 2. –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
const certPem = await fs.readFile(certPath, 'utf-8');
const keyPem = await fs.readFile(keyPath, 'utf-8');

// 3. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞–±–ª–æ–Ω–∞
const template = new Template('generic');

// 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –∫–ª—é—á–∞ –û–¢–î–ï–õ–¨–ù–´–ú–ò –º–µ—Ç–æ–¥–∞–º–∏
template.setCertificate(certPem);
template.setPrivateKey(keyPem); // –ü–∞—Ä–æ–ª—å –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∫–ª—é—á –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω

// 5. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
const pass = template.createPass({
  serialNumber: `loyalty-${Date.now()}`,
  description: 'Loy Digital Loyalty Card'
});

// ... (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Ç.–¥.)

// 6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
const pkpass = await pass.asBuffer();
await fs.writeFile('loyalty-card.pkpass', pkpass);

console.log('–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
```

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥–µ–∂–Ω—ã–º, –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏ –≥–æ—Ç–æ–≤—ã–º –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å `passService.ts`.
